{% from "core/map.jinja" import stash_keys with context %}
{% from "haraka/map.jinja" import haraka with context %}
include:
  - nodejs.install

git_clone:
  git.latest:
    - name: ssh://git@tmpstash01p:7999/pp/haraka.git 
    - target: /opt/haraka/  
    - identity: {{ stash_keys.private_path }} 
    - user: root
    - unless: ls -d /opt/haraka/
    - require:
      - sls: nodejs.install

install_dependencies:
  cmd.run:
    - name: | 
        cd /opt/haraka/
        npm install
    - env:
      - HOME: '/root'
    - shell: /bin/bash

haraka_service:
  file.managed:
    - name: {{ haraka.haraka_service_path }} 
    - source:
      - {{ haraka.haraka_service }}
    - template: jinja
    - user: root
    - group: root
    - mode: 755
  module.wait:
    - name: service.systemctl_reload
    - watch:
      - file: {{ haraka.haraka_service_path }}
  service.running:
    - name: haraka
    - enable: True
    - require:
      - file: {{ haraka.haraka_service_path }}
